<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دستیار کدنویسی Vibe</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet"
        type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #f50057;
            --background-light: #f5f7ff;
            --text-dark: #333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --info-color: #2196f3;
        }

        body {
            font-family: 'Vazirmatn', 'Tahoma', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            direction: rtl;
            text-align: right;
            padding-top: 2rem;
        }

        .container {
            max-width: 1200px;
        }

        .section-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .section-header {
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .section-body {
            padding: 20px;
        }

        .json-input-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            background-color: white;
            border-top: 1px solid var(--border-color);
            padding: 15px;
            z-index: 900;
            display: none;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-float {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border: none;
        }

        .prompt-template-container {
            position: relative;
        }

        .prompt-template {
            background-color: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-prompt-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .copy-prompt-btn:hover {
            background-color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4">
            <i class="fas fa-magic-wand-sparkles me-2"></i>دستیار کدنویسی Vibe
        </h1>

        <div id="empty-state-container" class="text-center pt-5">
            <div class="card shadow-sm" style="max-width: 600px; margin: auto;">
                <div class="card-body p-5">
                    <i class="fas fa-file-import fa-3x text-primary mb-4"></i>
                    <h2 class="card-title">بارگذاری مستندات پروژه</h2>
                    <p class="card-text text-muted">برای شروع فرآیند تولید پرامپت، لطفاً فایل JSON مستندات پروژه خود را
                        (خروجی `json-generator.html`) بارگذاری کنید.</p>
                    <p>بر روی دکمه شناور <i class="fas fa-code"></i> در گوشه پایین-چپ صفحه کلیک کرده، محتوای JSON را
                        وارد و سپس دکمه "بارگذاری" را بزنید.</p>
                </div>
            </div>
        </div>

        <div id="assistant-container" style="display: none;">
            <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    مستندات پروژه <strong id="loaded-project-name"></strong> با موفقیت بارگذاری شد. اکنون می‌توانید
                    فرآیند تولید پرامپت را آغاز کنید.
                </div>
            </div>

            <div class="section-card">
                <div class="section-header"><i class="fas fa-cogs me-2"></i> فرآیند تولید پرامپت زنجیره‌ای</div>
                <div class="section-body">
                    <p class="lead">این دستیار شما را قدم به قدم برای تبدیل مستندات به کد اجرایی راهنمایی می‌کند.</p>
                    <div class="accordion" id="vibeCodingAccordion">
                        <!-- Step 1: Module Definition -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingStep1">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseStep1" aria-expanded="true" aria-controls="collapseStep1">
                                    <strong>مرحله ۱:</strong> تعریف ماژول‌های پروژه
                                </button>
                            </h2>
                            <div id="collapseStep1" class="accordion-collapse collapse show"
                                aria-labelledby="headingStep1">
                                <div class="accordion-body">
                                    <p>در این مرحله، یک پرامپت برای مدل زبانی تولید می‌کنیم تا تمام نیازمندی‌های پروژه
                                        را تحلیل کرده و آنها را در ماژول‌های منطقی دسته‌بندی کند.</p>
                                    <button class="btn btn-primary mb-3" id="generate-step1-prompt-btn">
                                        <i class="fas fa-cogs me-2"></i>تولید پرامپت ماژول‌بندی
                                    </button>
                                    <div id="step1-prompt-area" style="display:none;">
                                        <h6>پرامپت تولید شده:</h6>
                                        <div class="prompt-template-container">
                                            <pre class="prompt-template" id="step1-prompt-output"></pre>
                                            <button class="copy-prompt-btn" data-target="step1-prompt-output"><i
                                                    class="fas fa-copy me-1"></i>کپی</button>
                                        </div>
                                        <hr>
                                        <label for="step1-response-input" class="form-label">پاسخ JSON مدل
                                            زبانی:</label>
                                        <textarea class="form-control" id="step1-response-input" rows="8"
                                            placeholder="پاسخ JSON دریافت شده از مدل زبانی را اینجا وارد کنید..."></textarea>
                                        <button class="btn btn-success mt-2" id="validate-step1-btn">
                                            <i class="fas fa-check me-2"></i>اعتبارسنجی و ادامه
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Step 2: Implementation Roadmap -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingStep2">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseStep2" aria-expanded="false" aria-controls="collapseStep2"
                                    disabled>
                                    <strong>مرحله ۲:</strong> طراحی نقشه راه پیاده‌سازی
                                </button>
                            </h2>
                            <div id="collapseStep2" class="accordion-collapse collapse" aria-labelledby="headingStep2">
                                <div class="accordion-body">
                                    <p>بر اساس ماژول‌های تعریف شده، یک پرامپت برای ایجاد نقشه راه اولویت‌بندی شده تولید
                                        می‌شود.</p>
                                    <div id="step2-content-area">
                                        <!-- Content will be generated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Step 3: Technical Tasks -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingStep3">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseStep3" aria-expanded="false" aria-controls="collapseStep3"
                                    disabled>
                                    <strong>مرحله ۳:</strong> شکستن نقشه راه به تسک‌های فنی
                                </button>
                            </h2>
                            <div id="collapseStep3" class="accordion-collapse collapse" aria-labelledby="headingStep3">
                                <div class="accordion-body" id="step3-content-area">
                                    <!-- Content will be generated by JS -->
                                </div>
                            </div>
                        </div>
                        <!-- Step 4: Code Generation -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingStep4">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseStep4" aria-expanded="false" aria-controls="collapseStep4"
                                    disabled>
                                    <strong>مرحله ۴:</strong> تولید پرامپت‌های کدنویسی
                                </button>
                            </h2>
                            <div id="collapseStep4" class="accordion-collapse collapse" aria-labelledby="headingStep4">
                                <div class="accordion-body" id="step4-content-area">
                                    <!-- Content will be generated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="btn-float" id="toggle-json-input" title="ورود JSON جدید"><i class="fas fa-code"></i></button>
    <div class="json-input-container" id="json-input-container">
        <div class="d-flex justify-content-between mb-2">
            <h5>ورود JSON مستندات پروژه</h5><button type="button" class="btn-close" id="close-json-input"></button>
        </div>
        <textarea id="jsonInput" class="form-control mb-2" rows="10"
            placeholder="محتوای فایل JSON خروجی از srs-json-generator.html را اینجا وارد کنید..."></textarea>
        <div class="d-flex justify-content-end"><button id="loadBtn" class="btn btn-primary">بارگذاری</button></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectData = null;
        const allEntitiesMap = new Map();
        const allRequirementsMap = new Map();

        // State for the Vibe Coding Assistant
        let projectModules = null;
        let implementationRoadmap = null;
        let technicalTasks = {};

        function initializeAssistant(data) {
            if (!data || !data.projectInfo) {
                alert('ساختار JSON نامعتبر است یا اطلاعات پروژه وجود ندارد.');
                return;
            }

            // Hide empty state and show assistant
            document.getElementById('empty-state-container').style.display = 'none';
            document.getElementById('assistant-container').style.display = 'block';

            currentProjectData = data;
            document.getElementById('loaded-project-name').textContent = data.projectInfo.name;

            // Populate maps for later use in prompt generation
            allEntitiesMap.clear();
            allRequirementsMap.clear();
            (data.entities || []).forEach(e => allEntitiesMap.set(e.id, e));
            (data.userRoles || []).forEach(role => (role.requirements || []).forEach(req => allRequirementsMap.set(req.id, req)));

            resetVibeAssistant();
        }

        // --- NEW: Vibe Coding Assistant Logic ---
        function resetVibeAssistant() {
            projectModules = null;
            implementationRoadmap = null;
            technicalTasks = {};

            document.getElementById('step1-prompt-area').style.display = 'none';
            document.getElementById('step1-response-input').value = '';

            document.querySelector('#headingStep2 button').setAttribute('disabled', true);
            document.querySelector('#collapseStep2').classList.remove('show');
            document.getElementById('step2-content-area').innerHTML = '';

            document.querySelector('#headingStep3 button').setAttribute('disabled', true);
            document.querySelector('#collapseStep3').classList.remove('show');
            document.getElementById('step3-content-area').innerHTML = '';

            document.querySelector('#headingStep4 button').setAttribute('disabled', true);
            document.querySelector('#collapseStep4').classList.remove('show');
            document.getElementById('step4-content-area').innerHTML = '';

            // Open the first step
            new bootstrap.Collapse(document.getElementById('collapseStep1')).show();
        }

        function generateStep1_ModulePrompt() {
            const allRequirements = currentProjectData.userRoles.flatMap(role => role.requirements.map(req => ({ id: req.id, name: req.name, description: req.description })));
            return `
تو یک معمار ارشد نرم‌افزار و تحلیلگر سیستم هستی. وظیفه تو این است که یک لیست طولانی از نیازمندی‌های پروژه را به ماژول‌های منطقی و قابل مدیریت تقسیم کنی.

**اطلاعات پروژه:**
نام: ${currentProjectData.projectInfo.name}
توضیحات: ${currentProjectData.projectInfo.description}

**لیست تمام نیازمندی‌های پروژه:**
${JSON.stringify(allRequirements, null, 2)}

**وظیفه شما:**
1.  تمام نیازمندی‌های بالا را به دقت بررسی کن.
2.  آن‌ها را بر اساس عملکرد و ارتباط موضوعی، در "ماژول‌های" منطقی دسته‌بندی کن. هر ماژول باید یک جنبه اصلی از سیستم را پوشش دهد (مثلاً "مدیریت کاربران"، "هسته آگهی‌ها"، "سیستم پشتیبانی").
3.  برای هر ماژول یک \`id\` منحصر به فرد (مانند "mod-user-management")، یک \`name\` فارسی (مانند "ماژول مدیریت کاربران") و یک \`description\` کوتاه ارائه بده.
4.  در نهایت، لیست شناسه‌های (\`id\`) نیازمندی‌هایی که به آن ماژول تعلق دارند را در آرایه \`requirementIds\` قرار بده.

**قوانین خروجی:**
- خروجی باید **فقط یک آرایه JSON** از آبجکت‌های ماژول باشد.
- هر نیازمندی باید دقیقاً به یک ماژول تعلق داشته باشد.
- از افزودن هرگونه متن یا توضیح اضافی در پاسخ خودداری کن.

**مثال ساختار خروجی:**
[
  {
    "id": "mod-user-management",
    "name": "ماژول مدیریت کاربران و احراز هویت",
    "description": "شامل تمام نیازمندی‌های مربوط به ثبت‌نام، ورود، پروفایل کاربری و مدیریت کاربران توسط ادمین.",
    "requirementIds": [
      "req-user-register",
      "req-user-login",
      "req-admin-user-view-list"
    ]
  }
]
`;
        }

        function generateStep2_RoadmapPrompt() {
            return `
تو یک مدیر محصول (Product Manager) و مدیر پروژه (Project Manager) با تجربه در پروژه‌های نرم‌افزاری هستی. وظیفه تو تبدیل ماژول‌های تعریف شده به یک نقشه راه (Roadmap) اولویت‌بندی شده و منطقی است.

**اطلاعات پروژه:**
نام: ${currentProjectData.projectInfo.name}

**ماژول‌های پروژه:**
${JSON.stringify(projectModules, null, 2)}

**وظیفه شما:**
1.  ماژول‌های بالا را به دقت بررسی کن و وابستگی‌های بین آن‌ها را تشخیص بده. (مثلاً ماژول "مدیریت آگهی" به ماژول "مدیریت کاربران" وابسته است).
2.  یک نقشه راه پیاده‌سازی مرحله به مرحله (phased roadmap) طراحی کن.
3.  این نقشه راه را بر اساس اولویت و وابستگی‌ها مرتب کن. ماژول‌های زیرساختی و پایه باید اولویت بالاتری داشته باشند.
4.  برای هر مرحله از نقشه راه، یک \`id\` (مانند "phase-1-core")، یک \`title\` (مانند "فاز اول: زیرساخت و هسته اصلی") و یک \`description\` کوتاه ارائه بده.
5.  در هر مرحله، لیست شناسه‌های ماژول‌هایی (\`moduleIds\`) که باید در آن فاز پیاده‌سازی شوند را مشخص کن.

**قوانین خروجی:**
- خروجی باید **فقط یک آرایه JSON** از آبجکت‌های مراحل نقشه راه باشد.
- از افزودن هرگونه متن یا توضیح اضافی در پاسخ خودداری کن.

**مثال ساختار خروجی:**
[
  {
    "id": "phase-1-core-setup",
    "title": "فاز ۱: زیرساخت و مدیریت کاربران",
    "description": "در این فاز، هسته اصلی سیستم شامل احراز هویت و مدیریت کامل کاربران پیاده‌سازی می‌شود.",
    "moduleIds": [
      "mod-user-management"
    ]
  },
  {
    "id": "phase-2-advertisements",
    "title": "فاز ۲: عملکرد اصلی آگهی‌ها",
    "description": "پیاده‌سازی تمام چرخه‌ی حیات آگهی‌ها از ثبت تا نمایش و مدیریت.",
    "moduleIds": [
      "mod-advertisement-core",
      "mod-advertisement-management"
    ]
  }
]
`;
        }

        function generateStep3_TasksPrompt(phase) {
            const relevantModules = projectModules.filter(m => phase.moduleIds.includes(m.id));
            const relevantReqs = relevantModules.flatMap(m => m.requirementIds).map(id => allRequirementsMap.get(id));

            return `
تو یک معمار نرم‌افزار و رهبر فنی (Tech Lead) هستی. وظیفه تو این است که نیازمندی‌های سطح بالا را به تسک‌های فنی مشخص، اتمیک و قابل اجرا برای تیم توسعه تقسیم کنی.

**مرحله فعلی نقشه راه:**
عنوان: "${phase.title}"
توضیحات: "${phase.description}"

**نیازمندی‌های مربوط به این مرحله:**
${JSON.stringify(relevantReqs, null, 2)}

**وظیفه شما:**
1.  تمام نیازمندی‌های بالا را که مربوط به فاز "${phase.title}" هستند، بررسی کن.
2.  آن‌ها را به یک لیست از تسک‌های فنی (Technical Tasks) بشکن.
3.  هر تسک باید یک کار مشخص و قابل اندازه‌گیری باشد. از تسک‌های خیلی کلی مانند "پیاده‌سازی کنترلر" خودداری کن و آن را به تسک‌های جزئی‌تر مانند "پیاده‌سازی اکشن Index برای نمایش لیست" و "پیاده‌سازی اکشن Create (POST) برای ذخیره‌سازی" تقسیم کن.
4.  برای هر تسک یک \`id\` (با پیشوند "task-")، یک \`title\` کوتاه و یک \`description\` فنی ارائه بده.
5.  هر تسک را به شناسه نیازمندی اصلی (\`relatedRequirementId\`) آن مرتبط کن.

**قوانین خروجی:**
- خروجی باید **فقط یک آرایه JSON** از آبجکت‌های تسک باشد.
- از افزودن هرگونه متن یا توضیح اضافی در پاسخ خودداری کن.

**مثال ساختار خروجی:**
[
  {
    "id": "task-001",
    "title": "ایجاد کنترلر UsersController",
    "description": "ایجاد فایل کنترلر UsersController در Area ادمین با متدهای اولیه Index, Details, Upsert (GET/POST) و Delete.",
    "relatedRequirementId": "req-admin-user-view-list"
  },
  {
    "id": "task-002",
    "title": "پیاده‌سازی اکشن Index در UsersController",
    "description": "پیاده‌سازی منطق دریافت لیست کاربران از دیتابیس با قابلیت صفحه‌بندی و جستجو برای نمایش در صفحه Index.",
    "relatedRequirementId": "req-admin-user-view-list"
  }
]
`;
        }

        function generateStep4_CodePrompt(task, requirement, entity) {
            return `
تو یک برنامه‌نویس ارشد فول-استک با تخصص در ASP.NET MVC 5 و Entity Framework هستی. وظیفه تو نوشتن کد تمیز، بهینه و دقیق بر اساس یک تسک فنی مشخص است.

**زمینه کلی پروژه:**
- نام پروژه: ${currentProjectData.projectInfo.name}
- تکنولوژی اصلی: ASP.NET MVC 5, C#, Entity Framework

**تسک فنی فعلی:**
- شناسه تسک: ${task.id}
- عنوان تسک: ${task.title}
- توضیحات تسک: ${task.description}

**نیازمندی مرتبط:**
- شناسه نیازمندی: ${requirement.id}
- نام نیازمندی: ${requirement.name}
- توضیحات نیازمندی: ${requirement.description}
- اطلاعات فنی: Controller: ${requirement.controllerName}, Area: ${requirement.areaName || 'None'}

**موجودیت اصلی مرتبط (در صورت وجود):**
${entity ? JSON.stringify(entity, null, 2) : 'این تسک به موجودیت خاصی وابسته نیست.'}

**تمام موجودیت های پروژه (برای درک روابط):**
${JSON.stringify(currentProjectData.entities, null, 2)}

**وظیفه شما:**
بر اساس تمام اطلاعات بالا، کد C# و/یا Razor (CSHTML) مورد نیاز برای تکمیل تسک "${task.title}" را بنویس.

**قوانین بسیار مهم:**
- **فقط کد بنویس.** از نوشتن هرگونه توضیح، مقدمه، نتیجه‌گیری یا عبارت "در اینجا کد مورد نظر شما آمده است" به شدت خودداری کن.
- اگر تسک مربوط به کنترلر است، فقط کد متد(های) مربوطه را بنویس.
- اگر تسک مربوط به View است، کد کامل CSHTML را ارائه بده.
- اگر تسک مربوط به منطق سرویس یا دیتابیس است، کد C# مربوط به آن را بنویس.
- کد باید خوانا، استاندارد و آماده استفاده باشد.
`;
        }

        // --- Event Listeners and UI Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const jsonInputContainer = document.getElementById('json-input-container');
            document.getElementById('toggle-json-input').addEventListener('click', () => {
                jsonInputContainer.style.display = jsonInputContainer.style.display === 'none' ? 'block' : 'none';
            });
            document.getElementById('close-json-input').addEventListener('click', () => {
                jsonInputContainer.style.display = 'none';
            });
            document.getElementById('loadBtn').addEventListener('click', () => {
                try {
                    const jsonText = document.getElementById('jsonInput').value;
                    if (!jsonText) { alert('لطفا ابتدا JSON را وارد کنید.'); return; }
                    const newData = JSON.parse(jsonText);
                    initializeAssistant(newData);
                    jsonInputContainer.style.display = 'none';
                } catch (error) { alert('خطا در پردازش JSON: ' + error.message); }
            });

            // Vibe Assistant Listeners
            document.getElementById('generate-step1-prompt-btn').addEventListener('click', () => {
                if (!currentProjectData) { alert('ابتدا یک پروژه را بارگذاری کنید.'); return; }
                const prompt = generateStep1_ModulePrompt();
                document.getElementById('step1-prompt-output').textContent = prompt;
                document.getElementById('step1-prompt-area').style.display = 'block';
            });

            document.getElementById('validate-step1-btn').addEventListener('click', () => {
                try {
                    const response = JSON.parse(document.getElementById('step1-response-input').value);
                    if (!Array.isArray(response) || response.length === 0 || !response[0].id || !response[0].requirementIds) {
                        throw new Error('ساختار JSON معتبر نیست یا با فرمت خواسته شده مطابقت ندارد.');
                    }
                    projectModules = response;
                    alert('ماژول‌ها با موفقیت اعتبارسنجی شدند. به مرحله بعد بروید.');

                    const step2Button = document.querySelector('#headingStep2 button');
                    step2Button.removeAttribute('disabled');
                    new bootstrap.Collapse(document.getElementById('collapseStep2')).show();

                    const step2Content = document.getElementById('step2-content-area');
                    step2Content.innerHTML = `
                        <button class="btn btn-primary mb-3" id="generate-step2-prompt-btn"><i class="fas fa-road me-2"></i>تولید پرامپت نقشه راه</button>
                        <div id="step2-prompt-area" style="display:none;">
                            <h6>پرامپت تولید شده:</h6>
                            <div class="prompt-template-container">
                                <pre class="prompt-template" id="step2-prompt-output"></pre>
                                <button class="copy-prompt-btn" data-target="step2-prompt-output"><i class="fas fa-copy me-1"></i>کپی</button>
                            </div>
                            <hr>
                            <label for="step2-response-input" class="form-label">پاسخ JSON مدل زبانی:</label>
                            <textarea class="form-control" id="step2-response-input" rows="8" placeholder="پاسخ JSON را اینجا وارد کنید..."></textarea>
                            <button class="btn btn-success mt-2" id="validate-step2-btn"><i class="fas fa-check me-2"></i>اعتبارسنجی و ادامه</button>
                        </div>
                    `;
                    document.getElementById('generate-step2-prompt-btn').addEventListener('click', () => {
                        const prompt = generateStep2_RoadmapPrompt();
                        document.getElementById('step2-prompt-output').textContent = prompt;
                        document.getElementById('step2-prompt-area').style.display = 'block';
                    });
                    document.getElementById('validate-step2-btn').addEventListener('click', validateAndProceedToStep3);

                } catch (error) {
                    alert('خطا: ' + error.message);
                }
            });

            document.body.addEventListener('click', function (event) {
                if (event.target.classList.contains('copy-prompt-btn') || event.target.parentElement.classList.contains('copy-prompt-btn')) {
                    const button = event.target.closest('.copy-prompt-btn');
                    const targetId = button.dataset.target;
                    const textToCopy = document.getElementById(targetId).textContent;
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        button.innerHTML = '<i class="fas fa-check me-1"></i>کپی شد';
                        setTimeout(() => { button.innerHTML = '<i class="fas fa-copy me-1"></i>کپی'; }, 2000);
                    });
                }
            });
        });

        function validateAndProceedToStep3() {
            try {
                const response = JSON.parse(document.getElementById('step2-response-input').value);
                if (!Array.isArray(response) || response.length === 0 || !response[0].id || !response[0].moduleIds) {
                    throw new Error('ساختار JSON نقشه راه معتبر نیست.');
                }
                implementationRoadmap = response;
                alert('نقشه راه با موفقیت اعتبارسنجی شد. به مرحله بعد بروید.');
                const step3Button = document.querySelector('#headingStep3 button');
                step3Button.removeAttribute('disabled');
                new bootstrap.Collapse(document.getElementById('collapseStep3')).show();

                const step3Content = document.getElementById('step3-content-area');
                let step3Html = '<p>برای هر مرحله از نقشه راه، پرامپت مربوط به تعریف تسک‌ها را تولید کنید.</p>';
                implementationRoadmap.forEach((phase, index) => {
                    step3Html += `
                        <div class="card mb-3">
                            <div class="card-header"><strong>${phase.title}</strong></div>
                            <div class="card-body">
                                <p>${phase.description}</p>
                                <button class="btn btn-primary btn-sm generate-step3-prompt-btn" data-phase-index="${index}"><i class="fas fa-tasks me-2"></i>تولید پرامپت تسک‌ها</button>
                                <div id="step3-prompt-area-${index}" class="mt-3" style="display:none;">
                                   <div class="prompt-template-container">
                                        <pre class="prompt-template" id="step3-prompt-output-${index}"></pre>
                                        <button class="copy-prompt-btn" data-target="step3-prompt-output-${index}"><i class="fas fa-copy me-1"></i>کپی</button>
                                    </div>
                                    <hr>
                                    <label for="step3-response-input-${index}" class="form-label">پاسخ JSON مدل زبانی:</label>
                                    <textarea class="form-control" id="step3-response-input-${index}" rows="8" placeholder="آرایه JSON تسک‌های این مرحله را اینجا وارد کنید..."></textarea>
                                    <button class="btn btn-success btn-sm mt-2 validate-step3-btn" data-phase-id="${phase.id}" data-phase-index="${index}"><i class="fas fa-check me-2"></i>ذخیره تسک‌ها</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                step3Content.innerHTML = step3Html;

                document.querySelectorAll('.generate-step3-prompt-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const index = e.target.dataset.phaseIndex;
                        const phase = implementationRoadmap[index];
                        const prompt = generateStep3_TasksPrompt(phase);
                        document.getElementById(`step3-prompt-output-${index}`).textContent = prompt;
                        document.getElementById(`step3-prompt-area-${index}`).style.display = 'block';
                    })
                });
                document.querySelectorAll('.validate-step3-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const index = e.target.dataset.phaseIndex;
                        const phaseId = e.target.dataset.phaseId;
                        try {
                            const tasks = JSON.parse(document.getElementById(`step3-response-input-${index}`).value);
                            if (!Array.isArray(tasks)) throw new Error('پاسخ باید یک آرایه JSON باشد.');
                            technicalTasks[phaseId] = tasks;
                            alert(`تسک‌های مربوط به "${implementationRoadmap[index].title}" با موفقیت ذخیره شد.`);
                            e.target.classList.remove('btn-success');
                            e.target.classList.add('btn-secondary');
                            e.target.textContent = 'ذخیره شد';
                            e.target.disabled = true;

                            if (Object.keys(technicalTasks).length === implementationRoadmap.length) {
                                const step4Button = document.querySelector('#headingStep4 button');
                                step4Button.removeAttribute('disabled');
                                new bootstrap.Collapse(document.getElementById('collapseStep4')).show();
                                renderStep4_CodePrompts();
                            }
                        } catch (err) {
                            alert('خطا در پردازش JSON تسک‌ها: ' + err.message);
                        }
                    })
                });
            } catch (err) {
                alert('خطا: ' + err.message)
            }
        }

        function renderStep4_CodePrompts() {
            const step4Content = document.getElementById('step4-content-area');
            let step4Html = '<p>برای هر تسک فنی، پرامپت دقیق مربوط به تولید کد را ایجاد کرده و برای مدل زبانی ارسال کنید.</p>';

            implementationRoadmap.forEach(phase => {
                step4Html += `<h5 class="mt-4">${phase.title}</h5>`;
                const tasksForPhase = technicalTasks[phase.id] || [];
                if (tasksForPhase.length > 0) {
                    step4Html += '<ul class="list-group">';
                    tasksForPhase.forEach(task => {
                        step4Html += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><strong>${task.title}:</strong> ${task.description}</span>
                                <button class="btn btn-primary btn-sm generate-step4-prompt-btn" data-task-id="${task.id}" data-phase-id="${phase.id}"><i class="fas fa-code me-2"></i>تولید پرامپت کد</button>
                            </li>
                            <li id="step4-prompt-area-${task.id}" class="list-group-item" style="display:none; background-color: #f8f9fa;">
                                <div class="prompt-template-container">
                                    <pre class="prompt-template" id="step4-prompt-output-${task.id}"></pre>
                                    <button class="copy-prompt-btn" data-target="step4-prompt-output-${task.id}"><i class="fas fa-copy me-1"></i>کپی</button>
                                </div>
                            </li>
                        `;
                    });
                    step4Html += '</ul>';
                }
            });
            step4Content.innerHTML = step4Html;

            document.querySelectorAll('.generate-step4-prompt-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    const taskId = button.dataset.taskId;
                    const phaseId = button.dataset.phaseId;
                    const task = technicalTasks[phaseId].find(t => t.id === taskId);
                    const requirement = allRequirementsMap.get(task.relatedRequirementId);
                    const entity = allEntitiesMap.get(requirement?.primaryEntityId);

                    const prompt = generateStep4_CodePrompt(task, requirement, entity);
                    const promptOutputEl = document.getElementById(`step4-prompt-output-${taskId}`);
                    const promptAreaEl = document.getElementById(`step4-prompt-area-${taskId}`);

                    promptOutputEl.textContent = prompt;
                    promptAreaEl.style.display = 'block';
                });
            });
        }
    </script>
</body>

</html>